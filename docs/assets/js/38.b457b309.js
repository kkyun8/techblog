(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{237:function(a,t,s){"use strict";s.r(t);var n=s(28),e=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server"}},[a._v("#")]),a._v(" Server")]),a._v(" "),s("p",[a._v("TODO:")]),a._v(" "),s("h3",{attrs:{id:"proxy-reverse-proxy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#proxy-reverse-proxy"}},[a._v("#")]),a._v(" Proxy & Reverse Proxy")]),a._v(" "),s("p",[a._v("基本 Proxy プロキシと言うのは、forward proxy のことを示す。")]),a._v(" "),s("p",[a._v("プロキシサーバーとリバースプロキシサーバーの違いは、\n受けたリクエストの伝達先が外部のサーバー(forword)の場合プロキシ。\n内部のサーバー(reverse)の場合リバースプロキシ。")]),a._v(" "),s("h1",{attrs:{id:"nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[a._v("#")]),a._v(" Nginx")]),a._v(" "),s("h3",{attrs:{id:"nginx-とは？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-とは？"}},[a._v("#")]),a._v(" Nginx とは？")]),a._v(" "),s("p",[a._v("トラフィックが多いウェブのため、Event-Driven の非同期 WebServerSoftWare。オープンソース")]),a._v(" "),s("h3",{attrs:{id:"apache-と比較した特徴"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-と比較した特徴"}},[a._v("#")]),a._v(" Apache と比較した特徴")]),a._v(" "),s("p",[a._v("1.非同期 EventDriven 方式(Apache は Thead 方式)")]),a._v(" "),s("p",[a._v("2.Apache は１つのスレッドが１つのクライアントなので１：１の構成になり、メモリ、CPU の負荷がかかる。Nginx は Apache の問題を解決するために多数のリクエストを無理なく処理可能\n3.Apache より少ないリソースでもっと早く動作。 4.小さいスレッドでクライアントのリクエストを処理できる")]),a._v(" "),s("p",[a._v("＊EventDriven とは？\nスレッド方式は１つの Connecting に１つの Core、Thread を使うか、\nEventDriven は「複数の Connection をまとめて、EventHandler で非同期方式で最初処理される物からロジックが動くこと。」なので、多数のクライアントが接続しても、サーバーが安定に動く。")]),a._v(" "),s("h3",{attrs:{id:"基本的な書き方例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本的な書き方例"}},[a._v("#")]),a._v(" 基本的な書き方例")]),a._v(" "),s("p",[a._v("default.conf")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("worker_processes  "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Default: 1")]),a._v("\n\nhttp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  log_format   main "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$remote_addr")]),a._v(" - "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$remote_user")]),a._v(" ["),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$time_local")]),a._v("]  "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$status")]),a._v(" '")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'\""),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$request")]),a._v('" '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$body_bytes_sent")]),a._v(' "'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$http_referer")]),a._v("\" '")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'\""),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$http_user_agent")]),a._v('" "'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$http_x_forwarded_for")]),a._v("\"'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n  access_log   logs/access.log  main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n  server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# php/fastcgi")]),a._v("\n    listen       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    server_name  domain1.com www.domain1.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    access_log   logs/domain1.access.log  main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    root         html"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    location ~ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v(".php$ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n      fastcgi_pass   "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1:1025"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("h3",{attrs:{id:"nginx-のログ出力設定はサーバーの-etc-logrotate-d-から設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-のログ出力設定はサーバーの-etc-logrotate-d-から設定"}},[a._v("#")]),a._v(" * Nginx のログ出力設定はサーバーの/etc/logrotate.d から設定")]),a._v(" "),s("h3",{attrs:{id:"nginx-の-proxy-pass、upstream"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-の-proxy-pass、upstream"}},[a._v("#")]),a._v(" Nginx の proxy_pass、upstream")]),a._v(" "),s("p",[a._v("Nginx プロキシを行うためには、proxy_pass を使う。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("location /test/ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  proxy_pass URL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("ここで注意点がある。")]),a._v(" "),s("p",[a._v("以下の二つ proxy_pass の設定の違いは URL の最後に「/」があるかないか、によってマッピングされる URL の差がある。")]),a._v(" "),s("p",[a._v("もし example.com/name/foo にリクエストを受けたら、")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("location /name/ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# /nameが削除されたhttp://127.0.0.1/fooへ")]),a._v("\n    proxy_pass http://127.0.0.1/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\nlocation /name/ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# そのままhttp://127.0.0.1/name/fooへ")]),a._v("\n    proxy_pass http://127.0.0.1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("以上のような動きになる。")]),a._v(" "),s("p",[a._v("さらに backup サーバーを運用するためには upstream に該当サーバーを設定する")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("upstream backend "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    server web1.example.com:80"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    server web2.example.com:80"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    server web3.example.com:80"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    listen       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.0")]),a._v(".0.0:80"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    server_name  localhost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        proxy_pass http://backend"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("h3",{attrs:{id:"nginx-の-grpc-gateway-proxy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-の-grpc-gateway-proxy"}},[a._v("#")]),a._v(" Nginx の gRPC-Gateway Proxy")]),a._v(" "),s("p",[a._v("＊参照\nhttp://mogile.web.fc2.com/nginx/http/ngx_http_grpc_module.html#grpc_read_timeout")]),a._v(" "),s("p",[a._v("Nginx に grpc proxy をサポートする機能があるので、簡単にプロキシサーバーを作成できる。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    listen "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9000")]),a._v(" http2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        grpc_pass "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1:8000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        grpc_pass "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1:9000 backup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);